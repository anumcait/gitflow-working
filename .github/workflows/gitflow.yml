name: CI - Format / Lint / Test / Security

on:
  push:
    branches:
      - "feature/**"
      - "hotfix/**"
      - "release/**"
      - "develop"
      - "main"
  pull_request:

jobs:

  format_lint:
    name: Format & Lint (black, ruff, eslint, pylint)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff pylint mypy

      - name: Run black
        run: black --check .

      - name: Run ruff
        run: ruff check .

      - name: Run pylint
        run: |
          if [ -f "app" ] || [ -d "src" ]; then
            pylint $(git ls-files '*.py')
          else
            echo "No Python package found, skipping pylint"
          fi

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Node dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          else
            echo "No JS project found, skipping eslint"
          fi

      - name: eslint
        run: |
          if [ -f "package.json" ]; then
            npx eslint .
          fi


  tests:
    name: Tests & Coverage - Python
    runs-on: ubuntu-latest
    needs: format_lint

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov httpx fastapi

      - name: Run tests
        run: |
          pytest --cov=. --cov-report=xml --disable-warnings -q

      - name: Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml


  security_scans:
    name: Security Scans (Bandit, pip-audit, Secret Scan)
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install security tools
        run: |
          pip install bandit pip-audit

      - name: Run Bandit
        run: bandit -r . -ll

      - name: Run pip-audit
        run: pip-audit --progress-spinner off

      - name: GitHub Secret Scan
        uses: anchore/scan-action@v3
        with:
          path: "."
          fail-build: true


  build_package:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: security_scans

    steps:
      - uses: actions/checkout@v4

      - name: Build Python Dist
        run: |
          python setup.py sdist bdist_wheel || echo "No Python package build"

      - name: Build Node
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm run build
          else
            echo "No JS frontend found"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            build/


  deploy:
    name: Deploy (only on main)
    runs-on: ubuntu-latest
    needs: build_package
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Perform deployment
        run: |
          echo "Deploying to production environment..."
          # your SSH / Docker / Cloud deploy steps go here
