name: Auto PR + Auto Merge (Feature → Develop)

on:
  push:
    branches:
      - 'feature/**'

  pull_request_review:
    types: [submitted]     # triggers auto merge after approval

permissions:
  pull-requests: write
  contents: write

jobs:

  # ----------------------------------------------------------
  # 1️⃣ AUTOMATICALLY CREATE PR WHEN FEATURE BRANCH IS PUSHED
  # ----------------------------------------------------------
  create-pr:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract branch name
        id: vars
        run: |
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Create PR safely
        id: pr
        run: |
          BRANCH="${{ steps.vars.outputs.branch }}"
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"

          echo "Creating PR from $BRANCH → develop"

          response=$(curl -s -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "{
              \"title\": \"Auto: Merge $BRANCH into develop\",
              \"body\": \"PR created automatically by GitHub Actions.\",
              \"head\": \"$BRANCH\",
              \"base\": \"develop\"
            }")

          echo "API Response: $response"

          # ---- check duplicate PR ----
          if echo "$response" | grep -q "pull request already exists"; then
            echo "✔ PR already exists."

            # look up PR number
            prnum=$(curl -s \
              -H "Authorization: token $TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/pulls?state=open \
              | jq -r ".[] | select(.head.ref == \"$BRANCH\") | .number")

            echo "existing_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$prnum" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ---- extract PR number ----
          prnum=$(echo "$response" | jq -r '.number // empty')

          if [ -z "$prnum" ]; then
            echo "❌ Failed to get PR number."
            echo "existing_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "existing_pr=false" >> $GITHUB_OUTPUT
          echo "pr_number=$prnum" >> $GITHUB_OUTPUT

      - name: PR Status
        run: |
          echo "Existing PR? ${{ steps.pr.outputs.existing_pr }}"
          echo "PR Number:  ${{ steps.pr.outputs.pr_number }}"

  # ----------------------------------------------------------
  # 2️⃣ AUTO-MERGE INTO DEVELOP AFTER APPROVAL
  # ----------------------------------------------------------
  auto-merge:
    if: github.event_name == 'pull_request_review'
    runs-on: ubuntu-latest

    steps:
      - name: Extract PR number
        id: find
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Check if PR is approved
        id: approval
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          PR=${{ steps.find.outputs.pr_number }}

          echo "Checking approvals for PR #$PR"

          reviews=$(curl -s \
            -H "Authorization: token $TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/reviews)

          echo "Reviews JSON:"
          echo "$reviews"

          if echo "$reviews" | grep -q '"state": "APPROVED"'; then
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "approved=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not approved
        if: steps.approval.outputs.approved == 'false'
        run: echo "❌ PR not approved yet — cannot merge."

      - name: Merge PR (squash)
        if: steps.approval.outputs.approved == 'true'
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          PR=${{ steps.find.outputs.pr_number }}

          echo "Merging PR #$PR into develop"

          merge=$(curl -s -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/merge \
            -d '{"merge_method":"squash"}')

          echo "Merge Response:"
          echo "$merge"

          if echo "$merge" | grep -q '"merged": true'; then
            echo "✔ Merge successful!"
          else
            echo "❌ Merge failed"
            exit 1
