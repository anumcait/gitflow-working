name: GitFlow Automation (Feature → Dev → Release)

on:
  push:
    branches:
      - 'feature/**'

env:
  PYTHONUNBUFFERED: 1

jobs:

  # Step 1: Prepare workspace
  prepare:
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.vars.outputs.branch }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set Vars
        id: vars
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install Deps
        run: pip install requests

  # Step 2: Handle Feature Branch → Auto PR → Dev
  feature_to_dev:
    needs: prepare
    if: startsWith(needs.prepare.outputs.branch_name, 'feature/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install Deps
        run: pip install requests

      - name: Auto PR feature → dev
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          python3 scripts/auto_merge.py \
            --action feature_to_develop \
            --branch "${GITHUB_REF#refs/heads/}"

  # Step 3: After dev gets updated → Create Release Branch
  create_release_from_dev:
    needs: feature_to_dev
    runs-on: ubuntu-latest
    if: success()  # Only after feature PR is created & dev updated

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Create Release Branch
        run: |
          VERSION="release/$(date +'%Y.%m.%d_%H%M')"
          echo "Creating release branch: $VERSION"
          git checkout dev
          git pull
          git checkout -b "$VERSION"
          git push origin "$VERSION"
