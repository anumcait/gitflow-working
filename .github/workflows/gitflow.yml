name: Auto PR + Auto Merge

on:
  push:
    branches:
      - "feature/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  auto_pr_merge:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Extract branch name
        id: vars
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Create PR (if not exists)
        id: create
        run: |
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          HEAD="${{ steps.vars.outputs.branch }}"
          BASE="develop"

          echo "Checking if PR already exists..."

          pr=$(curl -s \
            -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:${HEAD}&base=$BASE" \
            | jq -r '.[0].number')

          if [[ "$pr" == "null" ]]; then
            echo "Creating PR..."

            create=$(curl -s -X POST \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/pulls \
              -d "{\"title\": \"Auto PR $HEAD â†’ $BASE\", \"head\": \"$HEAD\", \"base\": \"$BASE\"}")

            pr=$(echo "$create" | jq -r '.number')
          fi

          echo "PR found/created: $pr"
          echo "pr_number=$pr" >> $GITHUB_OUTPUT

      - name: Merge PR
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          PR="${{ steps.create.outputs.pr_number }}"
          REPO="${{ github.repository }}"

          echo "Merging PR #$PR..."

          curl -s -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls/$PR/merge" \
            -d '{"merge_method":"squash"}'

      - name: Delete feature branch
        run: |
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          BRANCH="${{ steps.vars.outputs.branch }}"
          REPO="${{ github.repository }}"

          echo "Deleting branch $BRANCH..."

          curl -s -X DELETE \
            -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/git/refs/heads/$BRANCH"
