name: Auto PR + Merge + Test + Build

on:
  push:
    branches:
      - "feature/**"

permissions:
  contents: write
  pull-requests: write

env:
  BASE_BRANCH: develop
  TOKEN: ${{ secrets.PERSONAL_TOKEN }}

jobs:

  # -------------------------------------------------
  # 1Ô∏è‚É£ CREATE PR + AUTO MERGE
  # -------------------------------------------------
  create_and_merge_pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create.outputs.pr_number }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract branch name
        id: vars
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create PR
        id: create
        run: |
          BRANCH="${{ steps.vars.outputs.branch }}"
          BASE="${{ env.BASE_BRANCH }}"
          TOKEN="${{ env.TOKEN }}"

          echo "üìå Creating PR: $BRANCH ‚Üí $BASE"

          # Attempt to create PR
          RESULT=$(curl -s -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "{\"title\":\"Auto PR: $BRANCH ‚Üí $BASE\",\"head\":\"$BRANCH\",\"base\":\"$BASE\"}")

          # If PR already exists
          if echo "$RESULT" | grep -q "A pull request already exists"; then
            PR=$(curl -s -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH&base=$BASE" \
              | jq -r '.[0].number')
          else
            PR=$(echo "$RESULT" | jq -r '.number')
          fi

          echo "pr_number=$PR" >> $GITHUB_OUTPUT
          echo "‚úÖ PR #$PR created or already existed."

      - name: Auto-merge PR
        run: |
          PR="${{ steps.create.outputs.pr_number }}"
          TOKEN="${{ env.TOKEN }}"

          echo "üöÄ Attempting to auto-merge PR #$PR"

          # Retry 40 times √ó 5 sec = 200 seconds
          for i in {1..40}; do
            echo "üîç Checking mergeability ($i/40)..."

            GET=$(curl -s -H "Authorization: token $TOKEN" \
              https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR)

            MERGEABLE=$(echo "$GET" | jq -r '.mergeable')
            STATE=$(echo "$GET" | jq -r '.mergeable_state')

            echo "mergeable=$MERGEABLE | state=$STATE"

            if [[ "$MERGEABLE" == "true" ]] && [[ "$STATE" == "clean" || "$STATE" == "unstable" ]]; then
              echo "‚úÖ PR is mergeable!"
              break
            fi

            echo "‚è≥ Waiting 5 seconds..."
            sleep 5
          done

          if [[ "$MERGEABLE" != "true" ]]; then
            echo "‚ùå GitHub never marked PR as mergeable. Failing."
            exit 1
          fi

          echo "üî® Merging now..."

          MERGE=$(curl -s -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR/merge \
            -d '{"merge_method":"merge"}')

          echo "$MERGE"

          if echo "$MERGE" | grep -q "Pull Request successfully merged"; then
            echo "üéâ Merge successful!"
          else
            echo "‚ùå Merge failed!"
            exit 1
          fi


  # -------------------------------------------------
  # 2Ô∏è‚É£ RUN TESTS AFTER MERGE
  # -------------------------------------------------
  run_tests:
    runs-on: ubuntu-latest
    needs: create_and_merge_pr

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pytest
        run: pytest || exit 1


  # -------------------------------------------------
  # 3Ô∏è‚É£ BUILD PACKAGE
  # -------------------------------------------------
  build:
    runs-on: ubuntu-latest
    needs: run_tests

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build

      - name: Build wheel and sdist
        run: python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-build
          path: dist/*
