name: CI Pipeline

on:
  push:
    branches:
      - "**"
  pull_request:

jobs:

  auto_format:
    name: Auto-format with Black
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Black
        run: pip install black

      - name: Run black and auto-commit
        run: |
          black .
          if [[ `git status --porcelain` ]]; then
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"
            git add .
            git commit -m "Auto-format code using Black"
            git push
          fi

  lint_and_test:
    name: Lint + Tests + Security
    runs-on: ubuntu-latest
    needs: auto_format

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install ruff mypy pylint bandit pip-audit

      - name: Ruff Fix (auto fix and commit)
        run: |
          ruff check . --fix
          if [[ `git status --porcelain` ]]; then
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"
            git add .
            git commit -m "Auto-fix Ruff issues"
            git push
          fi

      - name: Run mypy
        run: mypy --config-file mypy.ini .

      - name: Pylint (style + code quality)
        run: |
          pylint $(git ls-files '*.py') || true

      - name: Pytest (with PYTHONPATH fix)
        run: |
          export PYTHONPATH="${{ github.workspace }}"
          echo "PYTHONPATH set to: $PYTHONPATH"
          pytest -q --disable-warnings --maxfail=1

      - name: Bandit (security static analysis)
        run: bandit -r . -c .bandit

      - name: pip-audit (known vulnerabilities)
        run: pip-audit || true

      - name: Secret scanning (basic)
        run: |
          if grep -R "API_KEY\|SECRET\|TOKEN\|PASSWORD" -n .; then
            echo "⚠️ Possible secret detected!"
          else
            echo "No secrets found."
          fi
