name: GitFlow Automation

on:
  push:
    branches:
      - 'feature/**'   # Developer pushes to feature
  pull_request:
    branches:
      - develop           # When PR merges to dev → trigger release creation

env:
  PYTHONUNBUFFERED: 1

#####################
# JOB 1 - PREPARE
#####################
jobs:
  prepare:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/feature/')
    outputs:
      branch_name: ${{ steps.vars.outputs.branch }}

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set Vars
        id: vars
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install Deps
        run: pip install requests

#############################
# JOB 2 – Feature → Dev PR
#############################
  feature_to_dev:
    needs: prepare
    if: startsWith(needs.prepare.outputs.branch_name, 'feature/')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install Deps
        run: pip install requests

      - name: Auto-PR feature → dev
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          python3 scripts/auto_merge.py \
            --action feature_to_develop \
            --branch "${GITHUB_REF#refs/heads/}"

#####################################################
# JOB 3 – Create Release Branch after Dev is updated
#####################################################
  create_release:
    runs-on: ubuntu-latest
    needs: feature_to_dev

    # Trigger ONLY when PR merges to dev
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'dev'

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set release version
        id: setver
        run: echo "VERSION=release/$(date +'%Y.%m.%d_%H%M')" >> $GITHUB_OUTPUT

      - name: Create Release Branch
        run: |
          VERSION="${{ steps.setver.outputs.VERSION }}"
          echo "Creating release branch: $VERSION"
          git fetch
          git checkout dev
          git pull
          git checkout -b "$VERSION"
          git push origin "$VERSION"

#################################################
# JOB 4 – Auto-PR release → main
#################################################
  pr_release_to_main:
    runs-on: ubuntu-latest
    needs: create_release

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Auto PR release → main
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          RELEASE_BRANCH: ${{ steps.setver.outputs.VERSION }}
        run: |
          python3 scripts/auto_merge.py \
            --action release_to_main \
            --branch "${RELEASE_BRANCH}"
