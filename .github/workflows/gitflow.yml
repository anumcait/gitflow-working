name: GitFlow Automation (Feature → Develop → Release → Main)

on:
  push:
    branches:
      - 'feature/**'  # Developer pushes feature branch
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - develop      # PR merged into develop triggers release creation

env:
  PREPROD_HOLD_SECONDS: 60   # Demo: 1 min pre-prod hold. Set to 86400 for 24 hrs in prod
  PYTHONUNBUFFERED: 1

#############################
# JOB 1 - Feature → Develop PR
#############################
jobs:
  feature_to_develop:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install dependencies
        run: pip install requests

      - name: Auto-create PR feature → develop
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Creating PR from ${BRANCH} → develop"
          python3 scripts/auto_merge.py --action feature_to_develop --branch "$BRANCH"

#############################
# JOB 2 - Create Release Branch after PR merged into develop
#############################
  create_release_from_develop:
    runs-on: ubuntu-latest
    needs: feature_to_develop
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'develop'

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set Release Version
        id: setver
        run: |
          VERSION="release/$(date +'%Y.%m.%d_%H%M')"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release Branch
        run: |
          VERSION="${{ steps.setver.outputs.VERSION }}"
          echo "Creating release branch: $VERSION"
          git fetch origin
          git checkout develop
          git pull origin develop
          git checkout -b "$VERSION"
          git push origin "$VERSION"

#############################
# JOB 3 - Auto-create PR Release → Main
#############################
  pr_release_to_main:
    runs-on: ubuntu-latest
    needs: create_release_from_develop
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: Install dependencies
        run: pip install requests

      - name: Auto-create PR release → main
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          RELEASE_BRANCH: ${{ steps.setver.outputs.VERSION }}
        run: |
          echo "Creating PR from $RELEASE_BRANCH → main"
          python3 scripts/auto_merge.py --action release_to_main --branch "$RELEASE_BRANCH"

#############################
# JOB 4 - Preprod Hold (demo 1 min)
#############################
  preprod_hold:
    runs-on: ubuntu-latest
    needs: pr_release_to_main
    steps:
      - name: Simulate Preprod Deploy
        run: |
          echo "Deploying release branch to PRE-PROD (demo hold ${PREPROD_HOLD_SECONDS} seconds)"
          sleep $PREPROD_HOLD_SECONDS
          echo "Preprod hold completed"

#############################
# JOB 5 - Optional: Tag Main Release
#############################
  tag_main_release:
    runs-on: ubuntu-latest
    needs: preprod_hold
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Create Tag
        run: |
          TAG="v$(date +'%Y.%m.%d_%H%M')"
          echo "Tagging main: $TAG"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git checkout main
          git pull origin main
          git tag "$TAG"
          git push origin "$TAG"

#############################
# JOB 6 - Optional: Merge Release back into Develop
#############################
  merge_release_back_to_develop:
    runs-on: ubuntu-latest
    needs: tag_main_release
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Merge main → develop
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          python3 scripts/auto_merge.py --action main_to_develop --branch main
