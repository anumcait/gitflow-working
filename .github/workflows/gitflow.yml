name: GitFlow Automation

on:
  push:
    branches:
      - "feature/**"
      - "develop"
      - "release/**"
      - "hotfix/**"

permissions:
  contents: write
  pull-requests: write

jobs:

  # STEP 1 — WHEN DEVELOPER PUSHES TO DEVELOP → CREATE RELEASE BRANCH
  create_release:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create release branch
        run: |
          REL="release-$(date +'%Y%m%d%H%M')"
          echo "RELEASE=$REL" >> $GITHUB_ENV
          git checkout -b $REL
          git push origin $REL

      - name: Create Pull Request (Release → preprod)
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Release Pipeline"
          body: "Auto-generated release branch from develop"
          base: preprod
          branch: ${{ env.RELEASE }}

  # STEP 2 — WHEN RELEASE BRANCH MERGED INTO PREPROD → WAIT TIMER
  wait_preprod:
    if: startsWith(github.ref, 'refs/heads/release/')
    needs: create_release
    runs-on: ubuntu-latest
    steps:
      - name: Hold for QA time (2 hours)
        run: sleep $((2 * 60 * 60))

  # STEP 3 — AFTER QA → AUTOMATIC PR TO MAIN
  promote_to_main:
    needs: wait_preprod
    runs-on: ubuntu-latest
    steps:
      - name: Create PR to MAIN
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Promote Release to MAIN"
          body: "Preprod QA completed, moving to production"
          base: main
          branch: ${{ github.ref_name }}  # current release branch

  # STEP 4 — HOTFIX FLOW
  hotfix_flow:
    if: startsWith(github.ref, 'refs/heads/hotfix/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create PR to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "HOTFIX → MAIN"
          base: main
          branch: ${{ github.ref_name }}

      - name: Create PR to develop
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "HOTFIX → DEVELOP"
          base: develop
          branch: ${{ github.ref_name }}
