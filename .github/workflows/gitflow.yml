name: Auto PR + Merge + Test + Build

on:
  push:
    branches:
      - "feature/**"

permissions:
  contents: write
  pull-requests: write

env:
  BASE_BRANCH: develop
  TOKEN: ${{ secrets.PERSONAL_TOKEN }}

jobs:

  # -------------------------------------------------
  # 1Ô∏è‚É£ CREATE & MERGE PR
  # -------------------------------------------------
  create_and_merge_pr:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.create.outputs.pr_number }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Git Identity
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Extract branch name
        id: vars
        run: |
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

    create_pr:
      runs-on: ubuntu-latest
  
      # ‚≠ê REQUIRED so other jobs can read the PR number
      outputs:
        pr_number: ${{ steps.create.outputs.pr_number }}
  
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            fetch-depth: 0
  
        - name: Extract branch name
          id: vars
          run: |
            BRANCH="${GITHUB_REF#refs/heads/}"
            echo "branch=$BRANCH" >> $GITHUB_OUTPUT
  
        - name: Create PR
          id: create
          run: |
            BRANCH="${{ steps.vars.outputs.branch }}"
            BASE_BRANCH="${{ env.BASE_BRANCH }}"
            TOKEN="${{ env.TOKEN }}"
  
            echo "Creating PR from $BRANCH ‚Üí $BASE_BRANCH"
  
            # Create PR
            result=$(curl -s -X POST \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/pulls \
              -d "{\"title\": \"Auto PR: $BRANCH ‚Üí $BASE_BRANCH\", \"head\": \"$BRANCH\", \"base\": \"$BASE_BRANCH\"}")
  
            # Detect duplicate PR scenario
            if echo "$result" | grep -q "A pull request already exists"; then
              PR=$(curl -s -H "Authorization: token $TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH&base=$BASE_BRANCH" \
                | jq -r '.[0].number')
            else
              PR=$(echo "$result" | jq -r '.number')
            fi
  
            echo "Created PR #$PR"
  
            # ‚≠ê Send PR number to workflow output
            echo "pr_number=$PR" >> $GITHUB_OUTPUT

        - name: Auto-merge PR
          run: |
            PR="${{ steps.extract_pr.outputs.pr_number }}"
  
            echo "Merging PR #$PR into develop"
  
            # Retry until GitHub reports mergeable == true
            for i in {1..10}; do
              echo "üîç Checking mergeability attempt $i/10..."
  
              GET=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR)
  
              MERGEABLE=$(echo "$GET" | jq -r '.mergeable')
              STATE=$(echo "$GET" | jq -r '.mergeable_state')
  
              echo "mergeable: $MERGEABLE | state: $STATE"
  
              if [[ "$MERGEABLE" == "true" ]]; then
                echo "‚úÖ Mergeable ‚Äî merging now..."
                break
              fi
  
              echo "‚è≥ Not mergeable yet, waiting 5 seconds..."
              sleep 5
            done
  
            if [[ "$MERGEABLE" != "true" ]]; then
              echo "‚ùå PR still not mergeable. Aborting."
              exit 1
            fi
  
            # Try merge now
            MERGE=$(curl -s -X PUT \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$GITHUB_REPOSITORY/pulls/$PR/merge \
              -d '{"merge_method":"merge"}')
  
            echo "$MERGE"
  
            MSG=$(echo "$MERGE" | jq -r '.message // empty')
  
            if [[ "$MSG" == "Pull Request successfully merged" ]]; then
              echo "üéâ Auto-merge successful!"
            else
              echo "‚ùå Merge failed!"
              exit 1
            fi


  # -------------------------------------------------
  # 2Ô∏è‚É£ RUN TESTS
  # -------------------------------------------------
  run_tests:
    runs-on: ubuntu-latest
    needs: create_and_merge_pr

    steps:
      - name: Run pytest
        run: |
          export PYTHONPATH="$PWD"
          python3 -m pytest || exit 1
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pytest
        run: pytest || exit 1


  # -------------------------------------------------
  # 3Ô∏è‚É£ BUILD PYTHON PACKAGE
  # -------------------------------------------------
  build:
    runs-on: ubuntu-latest
    needs: run_tests

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build

      - name: Build wheel and sdist
        run: python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-build
          path: dist/*
