name: GitFlow + Auto PR + CI

on:
  push:
    branches:
      - "feature/**"
      - "develop"
  pull_request:

permissions:
  contents: write
  pull-requests: write

env:
  BASE_BRANCH: develop


###########################################################
# 1️⃣ AUTO PR + AUTO MERGE (feature → develop)
###########################################################

jobs:

  auto_pr:
    name: Auto PR Creation
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/feature/')
    outputs:
      pr_number: ${{ steps.create.outputs.number }}

    steps:
      - uses: actions/checkout@v4

      - name: Extract branch name
        id: vars
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Create or Reuse PR
        id: create
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          BRANCH="${{ steps.vars.outputs.branch }}"

          echo "Checking if PR already exists..."

          EXISTING=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&head=${{ github.repository_owner }}:$BRANCH&base=$BASE_BRANCH" \
            | jq -r '.[0].number')

          if [[ "$EXISTING" != "null" ]]; then
            echo "PR already exists → #$EXISTING"
            echo "number=$EXISTING" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Creating new PR: $BRANCH → $BASE_BRANCH"

          CREATE=$(curl -s -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "{\"title\": \"PR: $BRANCH → $BASE_BRANCH\", \"head\": \"$BRANCH\", \"base\": \"$BASE_BRANCH\"}")

          echo "$CREATE"
          echo "number=$(echo "$CREATE" | jq -r '.number')" >> $GITHUB_OUTPUT


  auto_approve_and_merge:
    name: Auto Approve & Merge
    runs-on: ubuntu-latest
    needs: auto_pr
    if: ${{ needs.auto_pr.outputs.pr_number != 'null' }}

    steps:
      - name: Approve PR
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          PR="${{ needs.auto_pr.outputs.pr_number }}"

          echo "Approving PR #$PR"

          curl -s -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR/reviews" \
            -d '{"event":"APPROVE"}'

      - name: Merge PR
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          PR="${{ needs.auto_pr.outputs.pr_number }}"

          echo "Merging PR #$PR"

          curl -s -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR/merge" \
            -d '{"merge_method":"squash"}'


###########################################################
# 2️⃣ CI PIPELINE (Runs on PR + develop merge)
###########################################################

  ci_pipeline:
    name: Lint + Tests + Security
    runs-on: ubuntu-latest
    needs: auto_approve_and_merge

    if: >
      startsWith(github.ref, 'refs/heads/develop') ||
      github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install black ruff mypy pylint bandit pip-audit

      - name: Black Auto-format
        run: |
          black .
          if [[ `git status --porcelain` ]]; then
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"
            git add .
            git commit -m "Black auto-format"
            git push
          fi

      - name: Ruff Fix
        run: |
          ruff check . --fix
          if [[ `git status --porcelain` ]]; then
            git config --global user.name "github-actions"
            git config --global user.email "actions@github.com"
            git add .
            git commit -m "Ruff fixes"
            git push
          fi

      - name: Run mypy
        run: mypy --config-file mypy.ini .

      - name: Run pylint
        run: pylint $(git ls-files '*.py') || true

      - name: Run pytest
        run: |
          export PYTHONPATH="${{ github.workspace }}"
          pytest -q --disable-warnings --maxfail=1

      - name: Bandit security scan
        run: bandit -r . -c .bandit || true

      - name: pip-audit vulnerabilities
        run: pip-audit || true

      - name: Secret scanning
        run: |
          if grep -R "API_KEY\|SECRET_KEY\|PASSWORD=" -n .; then
            echo "Secret detected!"
            exit 1
          else
            echo "No secrets found."
          fi
