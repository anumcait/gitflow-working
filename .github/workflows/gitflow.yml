name: Auto PR + Auto Merge (Feature → Develop)

on:
  push:
    branches:
      - 'feature/**'

permissions:
  contents: write
  pull-requests: write

jobs:

  # ----------------------------------------------------------
  # 1️⃣ CREATE PR
  # ----------------------------------------------------------
  create-pr:
    runs-on: ubuntu-latest

    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}

    steps:
      - uses: actions/checkout@v4

      - name: Get feature branch name
        id: vars
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Create PR (or get existing)
        id: pr
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          BRANCH="${{ steps.vars.outputs.branch }}"

          echo "Creating PR from $BRANCH → develop"

          # Try creating PR
          response=$(curl -s -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "{
              \"title\": \"Auto: Merge $BRANCH into develop\",
              \"body\": \"Auto-created by GitHub Actions.\",
              \"head\": \"$BRANCH\",
              \"base\": \"develop\"
            }")

          echo "Response: $response"

          # If PR already exists, fetch PR number
          if echo "$response" | grep -q "already exists"; then
            prnum=$(curl -s \
              -H "Authorization: token $TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/pulls?state=open \
              | jq -r ".[] | select(.head.ref == \"$BRANCH\") | .number")

            echo "pr_number=$prnum" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract PR number for new PR
          prnum=$(echo "$response" | jq -r '.number')
          echo "pr_number=$prnum" >> $GITHUB_OUTPUT


  # ----------------------------------------------------------
  # 2️⃣ AUTO APPROVE THE PR
  # ----------------------------------------------------------
  auto-approve:
    runs-on: ubuntu-latest
    needs: create-pr

    steps:
      - name: Auto-approve PR
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          PR=${{ needs.create-pr.outputs.pr_number }}

          echo "Auto approving PR #$PR"

          curl -s -X POST \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/reviews \
            -d '{"event":"APPROVE"}'


  # ----------------------------------------------------------
  # 3️⃣ AUTO MERGE INTO DEVELOP
  # ----------------------------------------------------------
  auto-merge:
    runs-on: ubuntu-latest
    needs: [create-pr, auto-approve]

    steps:
      - name: Merge PR
        run: |
          TOKEN="${{ secrets.PERSONAL_TOKEN }}"
          PR=${{ needs.create-pr.outputs.pr_number }}

          echo "Merging PR #$PR into develop"

          merge=$(curl -s -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/merge \
            -d '{"merge_method":"squash"}')

          echo "Merge Response: $merge"

          if echo "$merge" | grep -q '"merged": true'; then
            echo "✔ Auto-merge successful!"
          else
            echo "❌ Auto-merge failed."
            exit 1
