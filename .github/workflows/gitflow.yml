name: Auto PR + Auto Merge (Industry Standard)

on:
  push:
    branches:
      - "feature/**"

permissions:
  contents: write
  pull-requests: write

env:
  BASE_BRANCH: develop
  TOKEN: ${{ secrets.PERSONAL_TOKEN }}

jobs:

  create_pr:
    runs-on: ubuntu-latest

    outputs:
      pr_number: ${{ steps.out.outputs.pr }}

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Get branch name
        id: vars
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Create PR or find existing
        id: create
        run: |
          BR="${{ steps.vars.outputs.branch }}"

          echo "üîµ Creating PR from $BR ‚Üí $BASE_BRANCH"

          # Try to create PR
          CREATE=$(curl -s -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d @- <<EOF
          {
            "title": "Auto: $BR ‚Üí $BASE_BRANCH",
            "head": "$BR",
            "base": "$BASE_BRANCH",
            "body": "Automated PR created by GitHub Actions."
          }
EOF
          )

          echo "API Response: $CREATE"

          # Check if duplicate PR exists
          if echo "$CREATE" | grep -q "A pull request already exists"; then
            echo "üü° PR already exists. Fetching existing PR..."
            PR=$(curl -s \
              -H "Authorization: Bearer $TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BR&base=$BASE_BRANCH" \
              | jq -r '.[0].number')
          else
            PR=$(echo "$CREATE" | jq -r '.number')
          fi

          echo "Found/Created PR #$PR"

          echo "pr=$PR" >> $GITHUB_OUTPUT

      - name: Add labels (optional)
        run: |
          PR="${{ steps.create.outputs.pr }}"
          curl -s -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$PR/labels \
            -d '{"labels":["auto-pr","feature"]}'

      - name: Set output
        id: out
        run: echo "pr=${{ steps.create.outputs.pr }}" >> $GITHUB_OUTPUT


  approve_and_merge:
    needs: create_pr
    runs-on: ubuntu-latest

    if: ${{ needs.create_pr.outputs.pr_number != '' && needs.create_pr.outputs.pr_number != 'null' }}
    
    steps:

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Wait until PR is mergeable
        id: wait_mergeable
        run: |
          PR="${{ needs.create_pr.outputs.pr_number }}"

          echo "üîµ Waiting for PR #$PR to become mergeable..."

          for i in {1..15}; do
            STATUS=$(curl -s \
              -H "Authorization: Bearer $TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/pulls/$PR)

            MERGEABLE=$(echo "$STATUS" | jq -r '.mergeable')
            STATE=$(echo "$STATUS" | jq -r '.mergeable_state')

            echo "mergeable=$MERGEABLE | state=$STATE"

            if [[ "$MERGEABLE" == "true" ]]; then
              echo "üü¢ PR is mergeable!"
              break
            fi

            echo "‚è≥ Retry $i/15 ‚Äî waiting 4s..."
            sleep 4
          done

          [[ "$MERGEABLE" != "true" ]] && echo "‚ùå Still not mergeable" && exit 1

      - name: Approve PR
        run: |
          PR="${{ needs.create_pr.outputs.pr_number }}"
          echo "üîµ Approving PR #$PR"

          curl -s -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/reviews \
            -d '{"event":"APPROVE"}'

      - name: Merge PR (squash)
        run: |
          PR="${{ needs.create_pr.outputs.pr_number }}"
          echo "üü¢ Merging PR #$PR"

          MERGE=$(curl -s -X PUT \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/merge \
            -d '{"merge_method":"squash"}')

          echo "$MERGE"

          if echo "$MERGE" | grep -q '"merged": true'; then
            echo "üéâ Merge successful"
          else
            echo "‚ùå Merge failed"
            exit 1
          fi
