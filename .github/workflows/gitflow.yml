name: Auto PR + Auto Merge (Feature → Develop)

on:
  push:
    branches:
      - "feature/**"     # Trigger only on feature branches

permissions:
  contents: write
  pull-requests: write

jobs:

  # ============================================================
  # 1️⃣ CREATE PR FROM feature/* → develop
  # ============================================================
  create_pr:
    runs-on: ubuntu-latest

    outputs:
      pr_number: ${{ steps.get_pr.outputs.number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract branch
        id: vars
        run: echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create
        run: |
          branch="${{ steps.vars.outputs.branch }}"

          response=$(curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "{
              \"title\": \"Auto: Merge $branch → develop\",
              \"body\": \"Automated PR created by GitHub Actions\",
              \"head\": \"$branch\",
              \"base\": \"develop\"
            }")

          echo "$response" > response.json

      - name: Extract PR number (new or existing)
        id: get_pr
        run: |
          # 1. If new PR created → take `.number`
          num=$(jq -r '.number // empty' response.json)

          # 2. If PR already exists → search PR by branch head
          if [ -z "$num" ]; then
            num=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              https://api.github.com/repos/${{ github.repository }}/pulls \
              | jq -r ".[] | select(.head.ref==\"${{ steps.vars.outputs.branch }}\") | .number")
          fi

          echo "PR found: $num"
          echo "number=$num" >> $GITHUB_OUTPUT


  # ============================================================
  # 2️⃣ AUTO-MERGE THE PR WHEN APPROVED
  # ============================================================
  auto_merge:
    needs: create_pr
    runs-on: ubuntu-latest

    steps:
      - name: Enable Auto-Merge
        run: |
          pr=${{ needs.create_pr.outputs.pr_number }}
          echo "Enabling auto-merge for PR #$pr"

          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$pr/auto-merge \
            -d "{\"merge_method\": \"merge\"}"
