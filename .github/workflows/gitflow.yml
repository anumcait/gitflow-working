name: GitFlow Automation (Feature â†’ Develop)

on:
  push:
    branches:
      - "feature/*"        # Runs only on push to feature branches, NOT on branch creation

permissions:
  contents: write
  pull-requests: write

env:
  GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}    # For PR CREATE + MERGE

jobs:

  create_pr:
    name: Create & Merge PR â†’ develop
    runs-on: ubuntu-latest

    outputs:
      pr_number: ${{ steps.pr.outputs.number }}

    steps:
      - uses: actions/checkout@v4

      - name: Create PR
        id: pr
        run: |
          PR=$(gh pr create \
            --title "Auto-PR: $GITHUB_REF_NAME â†’ develop" \
            --body "Automated PR generated by GitHub Actions." \
            --base develop \
            --head $GITHUB_REF_NAME \
            --repo $GITHUB_REPOSITORY \
            || echo "PR_EXISTS")

          if [[ "$PR" == "PR_EXISTS" ]]; then
            # Fetch existing PR number
            PR=$(gh pr list --head "$GITHUB_REF_NAME" --json number -q ".[0].number")
          fi

          echo "number=${PR##*/}" >> $GITHUB_OUTPUT

      # -----------------------
      # FIXED AND WORKING PART
      # -----------------------
      - name: Auto Approve PR (GitHub Actions bot)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}     # IMPORTANT!!!
        run: |
          echo "Approving PR ${{ steps.pr.outputs.number }} using GitHub Actions bot"
          gh pr review ${{ steps.pr.outputs.number }} --approve --repo $GITHUB_REPOSITORY

      - name: Auto Merge PR
        run: |
          gh pr merge ${{ steps.pr.outputs.number }} --merge --delete-branch --repo $GITHUB_REPOSITORY

  # -------------------------------------
  # PYTHON TEST STAGE (AFTER MERGE)
  # -------------------------------------
  tests:
    name: Run Python Tests
    runs-on: ubuntu-latest
    needs: create_pr

    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest || exit 1

  # -------------------------------------
  # PYTHON BUILD STAGE
  # -------------------------------------
  build:
    name: Build Python App
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          pip install build

      - name: Build wheel and sdist
        run: |
          python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: python-build
          path: dist/*

  # -------------------------------------
  # FINAL STAGE
  # -------------------------------------
  ready_for_release:
    name: Ready for Release Stage
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Summary
        run: |
          echo "âœ¨ Feature merged â†’ develop"
          echo "âœ” Tests passed"
          echo "âœ” Build generated"
          echo "ðŸš€ Ready for release"
