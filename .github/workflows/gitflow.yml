name: GitFlow PR Automation

on:
  push:
    branches:
      - feature/*

permissions:
  contents: write
  pull-requests: write

jobs:

  # ------------------------------------------------
  # 1) On Feature Push → Create PR → Approve → Merge to dev
  # ------------------------------------------------
  feature_to_dev:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python (for GitHub API triggers)
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Auto-create, approve, & merge PR (feature → dev)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
        run: |
          python3 <<'EOF'
          import os, requests, time

          token = os.environ["GH_TOKEN"]
          repo  = os.environ["REPO"]
          branch = os.environ["BRANCH"]

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          # 1️⃣ Create PR feature → dev
          pr_data = {
              "title": f"Auto PR Feature → dev ({branch})",
              "head": branch,
              "base": "develop",
              "body": "Automated PR created by GitHub Actions"
          }

          pr = requests.post(
              f"https://api.github.com/repos/{repo}/pulls",
              json=pr_data, headers=headers
          ).json()

          pr_number = pr["number"]
          print("PR created:", pr_number)

          # 2️⃣ Approve PR
          approval = requests.post(
              f"https://api.github.com/repos/{repo}/pulls/{pr_number}/reviews",
              json={"event": "APPROVE"},
              headers=headers
          )
          print("PR approved:", approval.status_code)

          # 3️⃣ Merge PR
          merge = requests.put(
              f"https://api.github.com/repos/{repo}/pulls/{pr_number}/merge",
              json={"merge_method": "merge"},
              headers=headers
          )
          print("PR merged:", merge.status_code)
          EOF

  # ------------------------------------------------
  # 2) After dev updated → Create PR dev → preprod
  # ------------------------------------------------
  dev_to_preprod:
    needs: feature_to_dev
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Create PR dev → preprod
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python3 <<'EOF'
          import os, requests

          token = os.environ["GH_TOKEN"]
          repo  = os.environ["REPO"]

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          # Create PR dev → preprod
          pr_data = {
              "title": "Promote dev → preprod",
              "head": "dev",
              "base": "preprod",
              "body": "Auto promotion pipeline"
          }

          pr = requests.post(
              f"https://api.github.com/repos/{repo}/pulls",
              json=pr_data, headers=headers
          ).json()

          print("Created PR:", pr)
          EOF

  # ------------------------------------------------
  # 3) Preprod → wait X hours → Auto-merge → main
  # ------------------------------------------------
  preprod_to_main:
    needs: dev_to_preprod
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Sleep for hold time
        run: |
          echo "Holding in preprod for 1 hour…"
          sleep 60     # <-- change to 24h = 86400 seconds

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install requests
        run: pip install requests

      - name: Create, Approve & Merge PR preprod → main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python3 <<'EOF'
          import os, requests

          token = os.environ["GH_TOKEN"]
          repo  = os.environ["REPO"]

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          # 1️⃣ Create PR preprod → main
          pr_data = {
              "title": "Promote preprod → main",
              "head": "preprod",
              "base": "main",
              "body": "Auto promotion to production"
          }

          pr = requests.post(
              f"https://api.github.com/repos/{repo}/pulls",
              json=pr_data, headers=headers
          ).json()

          pr_number = pr["number"]
          print("Created PR:", pr_number)

          # 2️⃣ Approve
          requests.post(
              f"https://api.github.com/repos/{repo}/pulls/{pr_number}/reviews",
              json={"event": "APPROVE"},
              headers=headers
          )

          # 3️⃣ Merge PR
          merge = requests.put(
              f"https://api.github.com/repos/{repo}/pulls/{pr_number}/merge",
              json={"merge_method": "merge"},
              headers=headers
          )
          print("Merged:", merge.text)
          EOF
