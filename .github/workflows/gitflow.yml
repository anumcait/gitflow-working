name: GitFlow Pipeline

on:
  push:
    branches:
      - "feature/*"
      - "release/*"
      - "hotfix/*"
      - "develop"
      - "preprod"

permissions:
  contents: write
  pull-requests: write

jobs:

  # ------------------------------------------------------
  # 1) FEATURE BRANCH
  # ------------------------------------------------------
  feature:
    if: startsWith(github.ref, 'refs/heads/feature/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Tests
        run: echo "Running feature branch tests"

      - name: Create PR → develop
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "develop"
          pr_title: "Feature → Develop"
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------
  # 2) RELEASE BRANCH
  # ------------------------------------------------------
  release:
    if: startsWith(github.ref, 'refs/heads/release/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Release
        run: echo "Building release"

      - name: Create Pull Request → preprod
        uses: repo-sync/pull-request@v2
        with:
          pr_title: "Release → Preprod"
          destination_branch: "preprod"
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------
  # 3) PRE-PROD APPROVAL HOLD
  # ------------------------------------------------------
  preprod:
    if: github.ref == 'refs/heads/preprod'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Pre-Prod Tests
        run: echo "Testing preprod"

      - name: Manual Approval
        uses: trstringer/manual-approval@v1
        with:
          approvers: "yourgithubid"
          minimum-approvals: 1

      - name: Merge Preprod → main
        run: |
          gh pr create --title "Preprod → Main" --base main --head preprod --body "Approved release merge"
          gh pr merge --auto --merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------
  # 4) HOTFIX BRANCH
  # ------------------------------------------------------
  hotfix:
    if: startsWith(github.ref, 'refs/heads/hotfix/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Hotfix Tests
        run: echo "Testing hotfix"

      - name: Create PR → main
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "main"
          pr_title: "Hotfix → Main"
          github_token: ${{ secrets.GITHUB_TOKEN }}
