name: Auto PR + Auto Merge (Feature → Develop)

on:
  push:
    branches:
      - 'feature/**'

  pull_request:
    types: [opened, reopened, synchronize, edited, ready_for_review, review_requested, submitted]
    branches:
      - develop

  pull_request_review:
    types: [submitted]   # triggers auto merge immediately after approval

permissions:
  pull-requests: write
  contents: write

jobs:

  # ----------------------------------------------------------
  # 1️⃣ CREATE PR WHEN FEATURE BRANCH IS PUSHED
  # ----------------------------------------------------------
  create-pr:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Extract branch name
        id: vars
        run: |
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Create PR safely
        id: pr
        run: |
          branch="${{ steps.vars.outputs.branch }}"
          echo "Creating PR: $branch → develop"

          response=$(curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "{
              \"title\":\"Auto: Merge $branch into develop\",
              \"body\":\"Automated PR from GitHub Actions.\",
              \"head\":\"$branch\",
              \"base\":\"develop\"
            }")

          echo "API Response:"
          echo "$response"

          # Detect duplicate PR (string)
          if echo "$response" | grep -q "pull request already exists"; then
            echo "existing_pr=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Detect GitHub validation error (422)
          if echo "$response" | grep -q "\"status\": \"422\""; then
            echo "existing_pr=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Validate JSON
          echo "$response" | jq empty 2>/dev/null
          if [ $? -ne 0 ]; then
            echo "existing_pr=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract PR number
          pr_number=$(echo "$response" | jq -r '.number')
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "existing_pr=false" >> $GITHUB_OUTPUT

      - name: Output PR result
        run: |
          if [ "${{ steps.pr.outputs.existing_pr }}" = "true" ]; then
            echo "✔ PR already exists — skipping create."
          else
            echo "✔ New PR created: #${{ steps.pr.outputs.pr_number }}"
          fi

  # ----------------------------------------------------------
  # 2️⃣ AUTO-MERGE PR INTO DEVELOP WHEN APPROVED
  # ----------------------------------------------------------
  auto-merge:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Get PR number
        id: pr
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Check if PR is approved
        id: approval
        run: |
          PR=${{ steps.pr.outputs.pr_number }}
          echo "Checking approvals for PR #$PR"

          reviews=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/reviews)

          echo "Reviews JSON:"
          echo "$reviews"

          # If any approval exists → approved=true
          if echo "$reviews" | grep -q '"state": "APPROVED"'; then
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "approved=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if not approved
        if: steps.approval.outputs.approved == 'false'
        run: echo "❌ PR is NOT approved — waiting."

      - name: Merge PR (squash)
        if: steps.approval.outputs.approved == 'true'
        run: |
          PR=${{ steps.pr.outputs.pr_number }}
          echo "Merging PR #$PR → develop"

          merge_response=$(curl -s -X PUT \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/$PR/merge \
            -d '{"merge_method": "squash"}')

          echo "Merge Response:"
          echo "$merge_response"

          if echo "$merge_response" | grep -q '"merged": true'; then
            echo "✔ Merge successful!"
          else
            echo "❌ Merge failed"
            exit 1
