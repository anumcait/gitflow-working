name: Full GitFlow Automation

on:
  push:
    branches:
      - "feature/**"
  pull_request:
    branches: [develop]

permissions:
  contents: write
  pull-requests: write

env:
  PYTHONUNBUFFERED: 1

# -------------------------------------------
# STAGE 1 - FEATURE → DEVELOP
# -------------------------------------------

jobs:

  pr_to_develop:
    name: Auto PR (feature → develop)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/feature/')

    outputs:
      pr_number: ${{ steps.create_pr.outputs.pull-request-number }}

    steps:
      - uses: actions/checkout@v4

      - name: Create Pull Request → develop
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Auto PR: ${{ github.ref_name }} → develop"
          body: Automated PR created by GitFlow pipeline.
          base: develop
          head: ${{ github.ref_name }}
          delete-branch: false

  ci_checks:
    name: Run Lint + Tests + Security
    needs: pr_to_develop
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest bandit pip-audit fastapi[all]

      - name: Ruff Lint
        run: ruff check .

      - name: Mypy
        run: mypy .

      - name: Pytest
        run: pytest -q

      - name: Bandit Security Scan
        run: bandit -r .

      - name: pip-audit
        run: pip-audit

      - name: Manual Secret Scan
        run: |
          if grep -R --exclude-dir={.git,.github,.mypy_cache,__pycache__} \
              -n "API_KEY\|SECRET_KEY\|ACCESS_KEY\|PRIVATE_KEY\|PASSWORD=" .; then
            echo "❌ Secret detected!"
            exit 1
          else
            echo "✔ No secrets found."
          fi

  auto_merge_develop:
    name: Auto Merge PR → develop
    needs: ci_checks
    runs-on: ubuntu-latest

    steps:
      - name: Auto-merge PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ needs.pr_to_develop.outputs.pr_number }}
          merge-method: squash

# -------------------------------------------
# STAGE 2 - DEVELOP → RELEASE
# -------------------------------------------

  create_release_branch:
    name: Create release branch
    runs-on: ubuntu-latest
    needs: auto_merge_develop
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4

      - name: Get next version
        id: version
        run: |
          echo "version=1.0.$(date +%s)" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          git checkout -b release/${{ steps.version.outputs.version }}
          git push origin release/${{ steps.version.outputs.version }}

      - name: Create PR release → preprod
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Release → Preprod"
          body: "Release build ready for preprod."
          base: preprod
          head: release/${{ steps.version.outputs.version }}

# -------------------------------------------
# STAGE 3 - PREPROD → MAIN
# -------------------------------------------

  promote_to_main:
    name: Promote preprod → main
    runs-on: ubuntu-latest
    needs: create_release_branch

    steps:
      - name: Create PR preprod → main
        id: pr_main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Promote Preprod → Main"
          base: main
          head: preprod
          body: "Auto promotion after preprod approval."

      - name: Auto merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.pr_main.outputs.pull-request-number }}
          merge-method: squash

# -------------------------------------------
# STAGE 4 - TAGGING MAIN
# -------------------------------------------

  create_tag:
    name: Tag Main
    runs-on: ubuntu-latest
    needs: promote_to_main

    steps:
      - uses: actions/checkout@v4

      - name: Create tag
        run: |
          TAG=v1.0.$(date +%s)
          git tag $TAG
          git push origin $TAG
          echo "Created tag $TAG"
