name: GitFlow Demo Pipeline

on:
  push:
    branches:
      - "**"   # run pipeline for all branches

env:
  PREPROD_HOLD_HOURS: "24"

jobs:

  # ------------------------------------------------
  # 1) TEST
  # ------------------------------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt || true

      - name: Run tests
        run: |
          echo "Running tests..."
          pytest -q
    if: always()

  # ------------------------------------------------
  # 2) BUILD
  # ------------------------------------------------
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3

      - name: Build Application
        run: |
          echo "Building application..."
          python build.py || echo "No build script found"

  # ------------------------------------------------
  # 3) FEATURE → DEVELOP
  # ------------------------------------------------
  feature_to_develop:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Merge feature to develop
        run: echo "Merging feature branch → develop"

  # ------------------------------------------------
  # 4) HOTFIX → MAIN & DEVELOP
  # ------------------------------------------------
  hotfix_to_main_and_develop:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/heads/hotfix/')
    steps:
      - name: Merge hotfix to main & develop
        run: echo "Merging hotfix branch → main & develop"

  # ------------------------------------------------
  # 5) RELEASE CREATION
  # ------------------------------------------------
  create_release:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Create Release
        run: echo "Creating a release from develop..."

  # ------------------------------------------------
  # 6) PREPROD DEPLOYMENT
  # ------------------------------------------------
  deploy_preprod:
    runs-on: ubuntu-latest
    needs: create_release
    if: startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Deploy to Preprod
        run: |
          echo "Deploying to PRE-PROD..."
          echo "Holding for $PREPROD_HOLD_HOURS hours before promotion..."

  # ------------------------------------------------
  # 7) PROMOTE RELEASE → MAIN & DEVELOP
  # ------------------------------------------------
  promote_release:
    runs-on: ubuntu-latest
    needs: deploy_preprod
    if: startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: Promote Release
        run: echo "Promoting release branch → main & develop..."

  # ------------------------------------------------
  # 8) PRODUCTION DEPLOYMENT
  # ------------------------------------------------
  deploy_prod:
    runs-on: ubuntu-latest
    needs: promote_release
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to Production
        run: |
          echo "Deploying latest release to PRODUCTION..."
          echo "Deployment completed!"
