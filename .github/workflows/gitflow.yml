name: GitFlow Pipeline

on:
  push:
    branches:
      - "feature/*"
      - "release/*"
      - "hotfix/*"
      - "develop"
      - "preprod"

permissions:
  contents: write
  pull-requests: write

jobs:

  # ------------------------------------------------------
  # 1) FEATURE BRANCH
  # ------------------------------------------------------
  feature:
    if: startsWith(github.ref, 'refs/heads/feature/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Tests
        run: echo "Running feature branch tests"

      - name: Create PR → develop
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "develop"
          pr_title: "Feature → Develop"
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------
  # 2) RELEASE BRANCH
  # ------------------------------------------------------
  release:
    if: startsWith(github.ref, 'refs/heads/release/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Release
        run: echo "Building release"

      - name: Create PR → preprod
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "preprod"
          pr_title: "Release → Preprod"
          github_token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------
  # 3) PRE-PROD APPROVAL HOLD
  # ------------------------------------------------------
  preprod:
    if: github.ref == 'refs/heads/preprod'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Pre-Prod Tests
        run: echo "Testing preprod"

      - name: Manual Approval
        uses: trstringer/manual-approval@v1
        with:
          approvers: "YOUR_GITHUB_USERNAME"
          minimum-approvals: 1

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y

      - name: Merge Preprod → main
        run: |
          gh pr create --title "Preprod → Main" --base main --head preprod --body "Approved release merge"
          gh pr merge --auto --merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------
  # 4) HOTFIX BRANCH
  # ------------------------------------------------------
  hotfix:
    if: startsWith(github.ref, 'refs/heads/hotfix/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Hotfix Tests
        run: echo "Testing hotfix"

      - name: Create PR → main
        uses: repo-sync/pull-request@v2
        with:
          destination_branch: "main"
          pr_title: "Hotfix → Main"
          github_token: ${{ secrets.GITHUB_TOKEN }}
